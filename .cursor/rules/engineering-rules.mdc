---
alwaysApply: true
---

# Cursor 全域規範（本專案專用，Agent 必讀）

## API 與錯誤（全域）
- 統一使用 `/api/v1/*`（舊端點已移除，v1 API 為唯一標準）
- 回應格式：`{ success, code, message, data }`
- 錯誤碼：UNAUTHORIZED/FORBIDDEN/NOT_FOUND/CONFLICT/VALIDATION_ERROR/INTERNAL_ERROR

## 後端約定（全域）
- 所有路由統一使用 `/api/v1/*`
- 變更密碼：提供 `PUT /api/v1/auth/change-password`（非強制，登入流程不鎖操作）
- 安全：`helmet`、`express-rate-limit`（`/auth/*`, `/queue/register`）、CORS 限定
- 日誌：`morgan`（dev/combined），未來改為結構化 JSON

## 前端約定（全域）
- `API_VERSION = 'v1'`（固定版本，統一 `/api/${API_VERSION}`）
- `services/*` 一律回傳 `response.data.data || response.data`（統一處理 v1 回應格式）
- 變更密碼為管理員可選操作，不在登入後強制彈窗
- 拆分巨型頁為元件與 hooks；表單驗證抽 schema

## 文件與提交（全域）
- 每次功能變更同步更新 `docs/PRD.md`（背景/AC）與 `docs/API_SPEC.md`
- **開發日誌維護**：重要修改必須更新 `docs/DEVELOPMENT_LOG.md`
  - **Bug修復**：記錄問題原因、解決方案、預防措施
  - **架構變更**：記錄設計決策、實現細節、影響範圍
  - **重大功能**：記錄開發過程、技術選擇、經驗教訓
  - **已知問題**：記錄技術債務、workaround、解決計劃
- **文檔同步工作流**：當 `docs/TODO.md` 任務狀態變更時，同步更新 `README.md` 的相關功能說明。特別是新功能開發或重構完成時，確保 README 反映最新的系統狀態。
- **需求開發流程**：新需求必須先在 `docs/PRD.md` 進行規劃與溝通確認後，再進行技術開發（API 設計、實作、測試）。Agent 須先更新 PRD 並等待確認，再執行後續開發任務。
- **任務確認機制**：TODO.md 任務標記完成前，需等用戶確認實際效果滿足需求，避免過早標記完成。
- PR 必附：變更摘要、驗收清單、回滾方式
  - 工程規範全文：即本檔（取代 `docs/ENGINEERING_RULES.md`）
  - 子領域規範：`backend-rules.mdc`、`frontend-rules.mdc`（位於 `.cursor/rules/`）

## To-Do 單一來源（全域）
- 所有重構任務以 `docs/TODO.md` 為權威清單，並同步到 Cursor 的 To-Do。
- Cursor/Agent 執行時，先讀 `docs/TODO.md` 確認當前任務，再動手改。

## 檔案定位與探索指南（Agent 必讀）
### 🔍 初次接觸或不熟悉功能時的探索順序：
1. **開發經驗**：`docs/DEVELOPMENT_LOG.md` → 了解已知問題、解決方案和技術決策
2. **需求了解**：`docs/PRD.md` → 了解功能背景與驗收條件
3. **API 規格**：`docs/API_SPEC.md` → 確認端點、請求/回應格式
4. **前端入口**：`frontend/src/pages/*` → 找到頁面主要元件
5. **後端入口**：`backend/src/routes/v1/*` → 找到對應路由與控制器

### 📂 關鍵檔案速查表：
**前端核心結構：**
- 頁面：`frontend/src/pages/` (AdminDashboardPage, RegisterPage 等)
- 元件：`frontend/src/components/` (按功能模組分組：admin/, registration/, common/, layout/)
- 狀態：`frontend/src/redux/slices/` (authSlice, queueSlice, uiSlice)
- 服務：`frontend/src/services/` (authService, queueService)
- Hooks：`frontend/src/hooks/admin/` (useQueueManagementRefactored 及其子 hooks: useQueueData, useQueueActions, useQueueUI, useQueueValidation)

**後端核心結構：**
- 路由：`backend/src/routes/v1/` (auth, queue, admin)
- 控制器：`backend/src/controllers/` (auth, queue, admin)
- 模型：`backend/src/models/` (user, queue)
- 中介層：`backend/src/middleware/` (auth, validation)
- 工具：`backend/src/utils/` (v1-response, validation)

### 🔎 常見問題的定位策略：
- **首要原則**：遇到問題先查看 `docs/DEVELOPMENT_LOG.md` 的"常見問題與解決方案"部分
- **前端白屏**：檢查 DEVELOPMENT_LOG.md → 控制台錯誤 → Redux狀態 → 組件import
- **API格式問題**：檢查 DEVELOPMENT_LOG.md → v1-response.js → 對應 controller → API_SPEC.md  
- **搜尋功能異常**：檢查 DEVELOPMENT_LOG.md → Service層格式處理 → Redux reducer → 後端格式
- **登入/認證問題**：authService → authSlice → auth.controller → user.model
- **候位功能問題**：queueService → queueSlice → queue.controller → queue.model
- **管理面板問題**：AdminDashboardPage → useQueueManagementRefactored → queueService → admin.controller
- **前端元件問題**：從 pages/ 開始，追蹤到 components/ 和 hooks/
- **Socket 即時更新**：socketService → 對應元件的 useEffect → backend socket 事件

### 💡 探索技巧：
- 使用 `codebase_search` 進行語意搜尋，如「用戶登入流程」、「候位狀態更新」
- 使用 `grep` 精確搜尋函式名、變數名、錯誤訊息
- 從錯誤訊息或 console.log 開始反向追蹤
- 檢查 import/export 關係來理解檔案間的依賴

## ⚠️ 重要原則：優先使用現有功能（Agent 必讀）
### 🔍 **新功能開發前的必要檢查**：
**在創建任何新的參數、函式、API、組件或模型之前，必須先進行全面探索：**

1. **參數/設定檢查**：
   - 搜尋 `SystemSetting` 模型和相關 API
   - 檢查管理員面板的系統設定功能
   - 確認是否已有類似的配置參數

2. **API 端點檢查**：
   - 搜尋現有 `/api/v1/*` 端點
   - 檢查 `docs/API_SPEC.md` 文檔
   - 確認是否已有類似功能的 API

3. **函式/Hook 檢查**：
   - 搜尋現有的 utils/、hooks/、services/ 目錄
   - 檢查是否已有類似邏輯的實現
   - 優先擴展現有函式而非新建

4. **資料庫欄位檢查**：
   - 檢查現有 models/ 中的 schema 定義
   - 搜尋相關的資料庫欄位和索引
   - 確認是否可重用現有欄位

### 🚫 **禁止的行為**：
- 未檢查現有功能就直接建立新的 API 端點
- 未搜尋現有參數就建立新的系統設定
- 未查閱現有 schema 就新增資料庫欄位
- 未檢查現有 hooks/utils 就建立新的功能函式

### ✅ **正確的工作流程**：
1. **第一步**：使用 `codebase_search` 和 `grep` 全面搜尋現有功能
2. **第二步**：檢查 `docs/API_SPEC.md` 和模型定義
3. **第三步**：評估是否可以擴展現有功能
4. **第四步**：只有在確認沒有現有解決方案時才建立新功能
5. **第五步**：新功能必須遵循現有的命名和結構慣例

**記住：重用和擴展現有功能比建立新功能更重要！** 🎯

## 開發與測試檔案管理（全域）
### 🧹 **測試檔案清理規範**：
- **必須清理**：所有為了測試目的而建立的暫時檔案，測試完成後必須立即刪除
- **禁止保留**：
  - 以 `test-*`、`*-test.*`、`api-test*`、`debug-*` 命名的檔案
  - 為了驗證或調試而建立的臨時腳本檔案
  - Git 指令殘留檔案或意外建立的無效檔案
- **清理時機**：
  - 功能測試完成後立即清理
  - 提交程式碼前必須檢查並清理所有測試檔案
  - 不允許將測試檔案推送到版本控制系統
- **例外規範**：
  - 正式的單元測試檔案（在 `tests/` 或 `__tests__/` 目錄下）
  - 有明確用途的工具腳本（如 `init-admin.js`、`update-existing-customers.js`）

**記住：保持專案整潔是每個開發者的責任！** 🧹

## 架構現狀（2025-11-29 重構完成）
- ✅ 統一 v1 API：所有端點使用 `/api/v1/*`，舊路由已完全移除
- ✅ 控制器統一：使用服務層架構，統一錯誤處理（catchAsync）
- ✅ 回應格式標準化：`{ success, code, message, data }`
- ✅ 前端服務層清理：統一回應處理 `response.data.data || response.data`
- ✅ Hooks 重構完成：使用模組化的 useQueueManagementRefactored
- ✅ 命名標準化：統一使用 kebab-case（如 `/queue/order`）
# 匯出功能擴展開發規劃

## 📋 概述

本文檔為候位系統新增兩個匯出功能的完整開發規劃：
1. **客戶資料表格範本 Excel 匯出** - 帶合併儲存格的標準表格格式
2. **修玄宮問事單 PDF 生成** - A4橫式頁面，雙A5直式問事單

兩個功能都包含**預覽機制**，新開網頁預覽後確認下載。

## 🎯 功能需求總結

### 資料篩選範圍
- 只匯出狀態為 `waiting` 和 `processing` 的客戶
- 包含客戶的所有家人

### 農曆日期處理
- 優先顯示農曆日期，格式：`民國XX年X月X日`
- 若無農曆日期則留空

### 操作流程
1. 管理員點擊「匯出資料」→ 選擇匯出類型
2. 新開網頁顯示預覽內容
3. 預覽頁面提供下載按鈕
4. 確認後點擊下載

## 📊 功能一：客戶資料表格範本 Excel

### 表格欄位結構
```
完成｜序號｜姓名｜人數｜性別｜農曆生日｜虛歲｜地址｜類型｜諮詢主題｜備註
```

### 合併儲存格邏輯
**需要合併的欄位**（主客戶+所有家人垂直合併）：
- `完成` - 空白欄位供手寫
- `序號` - 客戶的 queueNumber
- `人數` - 主客戶 + 家人總數
- `諮詢主題` - 主客戶的諮詢主題（中文化）
- `備註` - 主客戶的備註

**不合併的欄位**（每個人獨立）：
- `姓名` - 每個人的姓名
- `性別` - 每個人的性別（男/女）
- `農曆生日` - 每個人的農曆生日
- `虛歲` - 每個人的虛歲
- `地址` - 每個人的地址
- `類型` - 每個人的地址類型

### 完整合併示例
```
┌────┬────┬────┬───┬───┬──────────┬────┬──────────┬────┬────────┬────┐
│完成│序號│姓名│人數│性別│農曆生日    │虛歲│地址      │類型│諮詢主題│備註│
├────┼────┼────┼───┼───┼──────────┼────┼──────────┼────┼────────┼────┤
│    │  5 │張三│ 4  │男 │民國80年1月│35歲│台北市... │住家│身體、家運│    │
│    │    ├────┤    ├───┼──────────┼────┼──────────┼────┤        │    │
│    │    │李四│    │女 │民國82年3月│33歲│台北市... │住家│        │    │
│    │    ├────┤    ├───┼──────────┼────┼──────────┼────┤        │    │
│    │    │王五│    │男 │民國110年5月│3歲│台北市... │住家│        │    │
│    │    ├────┤    ├───┼──────────┼────┼──────────┼────┤        │    │
│    │    │小明│    │男 │民國112年8月│1歲│台北市... │住家│        │    │
└────┴────┴────┴───┴───┴──────────┴────┴──────────┴────┴────────┴────┘
```

## 📄 功能二：修玄宮問事單 PDF

### PDF 規格
- **頁面格式**: A4 橫式 (297×210mm)
- **問事單格式**: A5 直式 (210×148mm)
- **佈局**: 每頁兩張問事單左右排列
- **裁切線**: 中間留 2mm 虛線供裁切

### 問事單欄位設計
```
┌─────────────────────────────────────┐
│           修玄宮玄請示單             │
├─────────────┬─────────┬─────────────┤
│             │  地址：  │             │
│   請示內容   │ (客戶地址) │    姓名     │
│ (諮詢主題)   ├─────────┤ (客戶姓名)   │
│             │         │             │
│             │         ├─────────────┤
│             │         │    性別     │
│             │         │ (客戶性別)   │
│             │  年  年  ├─────────────┤
├─────────────┤         │    年齡     │
│   電話：     │  月  月  │ (客戶虛歲)   │
│ (客戶電話)   ├─────────┼─────────────┤
├─────────────┤         │   農曆出生   │
│   年  月  日 │  日  日  │ 年 月 日 時  │
│             │         │ (客戶農曆)   │
├─────────────┤         ├─────────────┤
│   編號：     │  時  時  │             │
│(候位號碼)    │         │             │
└─────────────┴─────────┴─────────────┘
```

### 資料對應
- **姓名**: customer.name
- **性別**: 男/女 (customer.gender)
- **年齡**: customer.virtualAge + "歲"
- **農曆出生**: 民國XX年X月X日格式
- **地址**: customer.addresses[0].address
- **電話**: customer.phone
- **編號**: customer.queueNumber
- **請示內容**: 諮詢主題中文化

## 🏗️ 技術架構規劃

### 新增/修改檔案清單
```
frontend/src/
├── components/
│   ├── ExportDialog.jsx (修改)
│   └── admin/
│       ├── ExcelPreviewTable.jsx (新增)
│       └── FormTemplate.jsx (新增)
├── pages/admin/
│   ├── ExcelPreviewPage.jsx (新增)
│   └── PDFPreviewPage.jsx (新增)
├── utils/
│   ├── exportUtils.js (修改)
│   └── pdfGenerator.js (新增)
└── App.js (修改 - 新增路由)
```

### 技術套件需求
```bash
npm install jspdf html2canvas
```

## 📝 開發檢查清單

### Phase 1: 基礎架構
- [ ] 修改 ExportDialog.jsx 新增兩個選項
- [ ] 新增預覽頁面路由結構
- [ ] 實作新開網頁邏輯

### Phase 2: Excel 功能
- [ ] 實作資料篩選邏輯 (waiting + processing)
- [ ] 實作合併儲存格邏輯
- [ ] 建立 Excel 預覽頁面
- [ ] 測試農曆日期格式化
- [ ] 測試人數計算邏輯

### Phase 3: PDF 功能
- [ ] 設計問事單 HTML 模板
- [ ] 實作 A4 橫式 + 雙 A5 直式佈局
- [ ] 建立 PDF 預覽頁面
- [ ] 測試 PDF 生成邏輯
- [ ] 驗證列印效果

### Phase 4: 整合測試
- [ ] 完整操作流程測試
- [ ] 預覽功能測試
- [ ] 下載功能測試
- [ ] 跨瀏覽器兼容性測試

## ⚠️ 關鍵技術重點

### Excel 合併儲存格實作
使用 XLSX 庫的 `!merges` 屬性：
```javascript
const merges = [];
let currentRow = 1; // 從第二行開始 (第一行是標題)

customers.forEach(customer => {
  const familySize = 1 + customer.familyMembers.length;
  const endRow = currentRow + familySize - 1;
  
  // 合併需要合併的欄位
  merges.push(
    { s: { r: currentRow, c: 0 }, e: { r: endRow, c: 0 } }, // 完成
    { s: { r: currentRow, c: 1 }, e: { r: endRow, c: 1 } }, // 序號
    { s: { r: currentRow, c: 3 }, e: { r: endRow, c: 3 } }, // 人數
    { s: { r: currentRow, c: 9 }, e: { r: endRow, c: 9 } }, // 諮詢主題
    { s: { r: currentRow, c: 10 }, e: { r: endRow, c: 10 } } // 備註
  );
  
  currentRow += familySize;
});

ws['!merges'] = merges;
```

### PDF 佈局實作
```css
.pdf-container {
  width: 297mm;
  height: 210mm;
  display: flex;
  flex-direction: row;
  background: white;
}

.form-left, .form-right {
  width: 147.5mm;
  height: 210mm;
  border: 1px solid black;
}

.cut-line {
  width: 2mm;
  height: 210mm;
  border-left: 1px dashed #999;
  margin: 0 1mm;
}
```

## 🚀 開發順序

1. **基礎框架** - 修改對話框和路由
2. **Excel 功能** - 實作合併邏輯和預覽
3. **PDF 功能** - 實作模板和生成
4. **整合測試** - 完整流程驗證

---

**開發時請嚴格遵循此規劃文檔，確保每個階段完成後進行充分測試！**

# 線上候位系統 PRD

## 背景與目標
- 不中斷服務情況下重構：統一 API、強化安全與可維護性、精煉文件，為後續快速擴充做準備。
- KPI：
  - 前台成功登記率 ≥ 98%
  - 登記/查詢流程錯誤率 ≤ 1%
  - 管理端日常操作錯誤率 ≤ 1%
  - 部署期間零停機（健康檢查 200 OK 維持）

## 角色與權限
- 訪客：登記候位（取決於 `publicRegistrationEnabled`）、查詢候位
- 管理員（admin/staff）：登入、查看列表、叫號、排序、編輯、取消/復原、刪除、匯出、系統設定

## 功能需求
1) 前台
- 候位登記（國曆/農曆、多地址、多家人、其他詳細內容、備註、生肖自動計算）
- 候位查詢（詳細需求如下）：
  - 支援姓名或電話任一條件查詢
  - 支援姓名+電話精確匹配查詢
  - 支援家人姓名搜尋（可用家人姓名查詢該家庭的候位記錄）
  - 顯示詳細候位資訊：叫號順序、前方等待人數、預估等待時間、預估輪到時間、生肖
  - 支援多筆記錄顯示（同一電話多個候位記錄）
  - 提供完整的錯誤提示和邊界情況處理
- 導航與首頁依 `publicRegistrationEnabled` 或登入狀態顯示「我要候位」

2) 後台
- 候位列表（拖曳排序、快速完成移末尾、取消/復原、編輯、刪除、匯出、顯示生肖欄位）
- 叫號（更新 `currentQueueNumber`）
- 設定（`isQueueOpen`、`nextSessionDate`、`maxOrderIndex`、`minutesPerCustomer`、`simplifiedMode`、`publicRegistrationEnabled`）
- 變更密碼功能（保留預設 admin/admin123；不強制首次登入）
- 客戶資料編輯時自動重新計算生肖（若出生日期有變更）

3) 系統/平台
- 健康檢查 `/health`，就緒檢查 `/ready`（後續）
- Zeabur 前後端分離部署，前端 `PORT=80`，CORS 對應網域

## 非功能需求（NFR）
- 可用性：無停機滾動部署；健康/就緒探針
- 效能：主要查詢有索引（status、orderIndex、phone、queueNumber），TTFB < 500ms（P95）
- 安全：JWT 強密鑰、Helmet、速率限制、提供手動變更密碼
- 可維護性：API 規格統一、錯誤碼一致、結構化日誌、單元&整合測試

## 里程碑
- M0：建立 PRD/API 規格/Engineering Rules + `.cursor/rules`
- M1：後端新增 `/api/v1`（相容）、新增 `change-password`、安全強化
- M2：前端切到 v1、加入強制改密 UI、服務層統一回傳格式、拆分大檔
- M3：觀察 1~2 週 → 下線舊端點、清理相容碼；精煉文檔完成

## 風險
- 回應格式不一致導致前端解構錯誤 → 先以 v1 增量、環境可回退舊端點
- 強制改密阻塞操作 → 僅限制後台功能，保留登出/改密操作

## 功能擴充記錄

### 生肖欄位自動計算功能（2026-01-11）

**背景**：
為方便客戶資料管理，系統需要自動記錄客戶的生肖資訊。

**功能說明**：
- 系統根據客戶的農曆出生年份自動計算生肖
- 生肖計算排在國農曆轉換之後，確保有完整的農曆生日資料
- 支援主客戶和家人資料的生肖計算

**驗收條件**：
- ✅ 客戶報名時，系統自動根據農曆生日計算生肖並儲存
- ✅ 編輯客戶出生日期後，系統自動更新生肖
- ✅ 家人資料也支援生肖計算
- ✅ 前端註冊表單顯示生肖欄位（唯讀，即時預覽）
- ✅ 管理面板客戶列表和詳細資料顯示生肖欄位
- ✅ 生肖計算失敗不阻擋整個報名流程

**技術實現**：
- 後端：使用 `lunar-javascript` 套件的 `.getYearShengXiao()` 方法
- 資料模型：在 `WaitingRecord` 和 `familyMemberSchema` 新增 `zodiac` 欄位（String, optional）
- 計算時機：在 `autoFillDates` 之後、`addVirtualAge` 之前執行 `addZodiac`
- 前端：同步實作計算函數用於即時預覽，但最終儲存值以後端計算為準


